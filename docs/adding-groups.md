# Adding Groups to Text the Check

This guide explains how to create new groups and manage users in Text the Check.

---

## Quick Reference

| Task | Method |
|------|--------|
| Create a new group | Seed script or manual Firestore |
| Add users to a group | Seed script or manual Firestore |
| Authorize WhatsApp access | Update `ALLOWED_PHONE_NUMBERS` on Render |
| Update user email | `npx tsx scripts/updateUserEmail.ts` |

---

## 1. Creating a New Group

### Option A: Using a Seed Script (Recommended)

Create a script like `server/scripts/seedTestGroup.ts`:

```typescript
// Example: server/scripts/seedMyGroup.ts
import admin from 'firebase-admin'
// ... (see seedTestGroup.ts for full template)

const NEW_USER: SeedUser = {
  name: 'User Name',
  phone: '+5493794XXXXXX',  // or null if no WhatsApp
  email: null,              // or 'user@gmail.com' for dashboard access
  aliases: ['name', 'nick']
}

const GROUP_ID = 'my-group-id'
```

Run the script:
```bash
cd server
npx tsx scripts/seedTestGroup.ts
```

### Option B: Manual Firestore (Firebase Console)

1. Go to [Firebase Console](https://console.firebase.google.com) > Firestore Database

2. **Create users** in the `users` collection:
   ```json
   {
     "id": "<auto-generated>",
     "name": "User Name",
     "phone": "+5493794XXXXXX",
     "email": null,
     "aliases": ["name", "nick"],
     "createdAt": "<timestamp>"
   }
   ```

3. **Create group** in the `groups` collection:
   ```json
   {
     "id": "my-group-id",
     "name": "My Group Name",
     "members": ["user-id-1", "user-id-2", "user-id-3"],
     "createdBy": "creator-user-id",
     "createdAt": "<timestamp>"
   }
   ```

---

## 2. Adding Users to an Existing Group

### Via Firestore Console

1. Navigate to `groups/{groupId}`
2. Edit the `members` array
3. Add the new user's ID to the array

### Via Script

Modify your seed script to update an existing group:

```typescript
await db.collection('groups').doc('existing-group-id').update({
  members: admin.firestore.FieldValue.arrayUnion('new-user-id')
})
```

---

## 3. Authorizing WhatsApp Numbers

For a user to send WhatsApp messages to the bot, their phone number must be in the `ALLOWED_PHONE_NUMBERS` environment variable.

### On Render (Production)

1. Go to [Render Dashboard](https://dashboard.render.com)
2. Select your service: `viaje-grupo-server`
3. Click "Environment" in the left sidebar
4. Find `ALLOWED_PHONE_NUMBERS`
5. Add the new phone number (comma-separated):
   ```
   +5493794702813,+5493794702875,...,+5493794574159
   ```
6. Click "Save Changes" (service will restart)

### Local Development

Update your `.env` file:
```env
ALLOWED_PHONE_NUMBERS=+5493794702813,+5493794702875,...,+5493794574159
```

---

## 4. Updating a User's Email

When a user provides their Google email (needed for dashboard access):

```bash
cd server
npx tsx scripts/updateUserEmail.ts --phone="+5493794574159" --email="user@gmail.com"
```

The email must match what they use to sign in with Google.

---

## 5. Multi-Group Users

### How It Works

Users can now belong to multiple groups and select which group receives their WhatsApp expenses.

The `activeGroupId` field on the user document determines which group is currently active:
- When set: Expenses go to the specified group
- When null: Expenses go to the first group found (fallback behavior)

### Selecting Active Group

#### Via WhatsApp: `/grupo` Command

Users with multiple groups can switch using the `/grupo` command:

```
User: /grupo

Bot: ðŸ“ *Tus grupos:*

1. Brazil Trip 2025 âœ“
2. Demo Group
3. Brazil 2026 Ingleses

Grupo activo: *Brazil Trip 2025*

_RespondÃ© con el nÃºmero para cambiar de grupo._

User: 3

Bot: âœ… Grupo activo cambiado a: *Brazil 2026 Ingleses*

Tus prÃ³ximos gastos se registrarÃ¡n en este grupo.
```

For users in only one group:
```
Bot: ðŸ“ Tu grupo: *Brazil Trip 2025*

_(Solo pertenecÃ©s a un grupo)_
```

#### Via Dashboard

The group selector in the dashboard header syncs with `activeGroupId`:
- Selecting a group updates `activeGroupId` in Firestore
- On page load, reads `activeGroupId` to set initial selection
- Priority order: `activeGroupId` > localStorage > first group

### Implementation Details

Key files:
- `server/src/services/userService.ts` - `getGroupByUserId()`, `updateUserActiveGroup()`, `getAllGroupsByUserId()`
- `server/src/services/commandService.ts` - `/grupo` command logic, pending selection state
- `client/stores/useGroupStore.ts` - Dashboard group sync with Firestore

---

## Existing Scripts

| Script | Purpose |
|--------|---------|
| `scripts/seedUsers.ts` | Seeds the original 11 users + Brazil Trip 2025 group |
| `scripts/seedTestGroup.ts` | Seeds Demo Group with test users |
| `scripts/seedBrazil2026Group.ts` | Seeds Brazil 2026 Ingleses group (5 members) |
| `scripts/updateUserEmail.ts` | Updates a user's email by phone |

---

## Checklist for Adding a New Group

- [ ] Create user documents in Firestore (via script or manual)
- [ ] Create group document with member IDs
- [ ] Add phone numbers to `ALLOWED_PHONE_NUMBERS` on Render
- [ ] (Optional) Update user emails when provided for dashboard access
- [ ] Test WhatsApp message flow
- [ ] Test dashboard access

---

## Troubleshooting

### "User not found" when sending WhatsApp

1. Check phone is in `ALLOWED_PHONE_NUMBERS`
2. Verify user document exists with matching `phone` field
3. Phone format must match (with `+` country code)

### "Access denied" on dashboard

1. User must have an `email` field set
2. Email must match their Google account exactly
3. Use `updateUserEmail.ts` to set/fix email

### Expenses going to wrong group

This happens with multi-group users. Solution: Use `/grupo` in WhatsApp to select the correct active group, or switch groups in the dashboard (the setting syncs automatically).
